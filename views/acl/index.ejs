<%- include('../partials/header-standalone') %>

<div class="container-main">
    <!-- Page Header -->
    <div class="page-header mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">
                    <i class="fas fa-shield-alt text-indigo-600 mr-3"></i>
                    Access Control Lists
                </h1>
                <p class="text-gray-600 mt-2">Define and manage ACLs for fine-grained DNS access control</p>
            </div>
        </div>
    </div>

    <!-- Messages -->
    <% if (successMessage) { %>
        <div class="mb-6 p-4 bg-green-50 border border-green-200 text-green-700 rounded-lg">
            <i class="fas fa-check-circle mr-2"></i>
            <%= successMessage %>
        </div>
    <% } %>

    <% if (errorMessage) { %>
        <div class="mb-6 p-4 bg-red-50 border border-red-200 text-red-700 rounded-lg">
            <i class="fas fa-exclamation-circle mr-2"></i>
            <%= errorMessage %>
        </div>
    <% } %>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Create ACL Form -->
        <div class="lg:col-span-1">
            <div class="content-card">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                    <i class="fas fa-plus-circle text-indigo-600 mr-2"></i>
                    Create New ACL
                </h3>

                <form id="createACLForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ACL Name</label>
                        <input type="text" name="name" id="aclName" 
                            class="form-input w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                            placeholder="e.g., trusted-clients"
                            required>
                        <p class="text-xs text-gray-500 mt-1">Letters, numbers, hyphens, and underscores only</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Description (Optional)</label>
                        <input type="text" name="description" id="aclDescription"
                            class="form-input w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                            placeholder="What is this ACL for?">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Entries</label>
                        <div id="entriesContainer" class="space-y-2 mb-2">
                            <div class="entry-row flex gap-2">
                                <input type="text" class="entry-address flex-1 px-2 py-1 border border-gray-300 rounded text-sm"
                                    placeholder="IP address, range, or keyword (any, none, localhost, localnets)">
                                <label class="flex items-center whitespace-nowrap">
                                    <input type="checkbox" class="entry-negated mr-1">
                                    <span class="text-xs">Negate</span>
                                </label>
                                <button type="button" class="btn-remove-entry px-2 py-1 bg-red-100 text-red-600 text-xs rounded hover:bg-red-200"
                                    style="display:none;">Remove</button>
                            </div>
                        </div>
                        <button type="button" id="addEntryBtn" class="text-sm text-indigo-600 hover:text-indigo-700 font-medium">
                            + Add Entry
                        </button>
                    </div>

                    <div class="flex gap-2">
                        <button type="submit" class="flex-1 bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 font-medium">
                            Create ACL
                        </button>
                        <button type="reset" class="flex-1 bg-gray-200 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-300 font-medium">
                            Reset
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ACLs List -->
        <div class="lg:col-span-2">
            <div class="content-card">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                    <i class="fas fa-list text-indigo-600 mr-2"></i>
                    Current ACLs
                    <span class="text-sm font-normal text-gray-600">(<%= acls.length %> defined)</span>
                </h3>

                <% if (acls.length === 0) { %>
                    <div class="p-8 text-center bg-gray-50 rounded-lg">
                        <i class="fas fa-inbox text-4xl text-gray-300 mb-3"></i>
                        <p class="text-gray-600">No ACLs defined yet</p>
                        <p class="text-sm text-gray-500 mt-1">Create your first ACL using the form on the left</p>
                    </div>
                <% } else { %>
                    <div class="space-y-3">
                        <% acls.forEach(acl => { %>
                            <div class="p-4 border border-gray-200 rounded-lg hover:border-indigo-200 hover:bg-indigo-50 transition">
                                <div class="flex items-start justify-between mb-2">
                                    <div>
                                        <h4 class="font-semibold text-gray-800"><%= acl.name %></h4>
                                        <p class="text-xs text-gray-500 mt-1">
                                            <i class="fas fa-file text-gray-400 mr-1"></i>
                                            <%= acl.file.replace('/etc/bind/', '') %>
                                        </p>
                                    </div>
                                    <button type="button" class="btn-delete-acl px-3 py-1 bg-red-100 text-red-600 text-xs rounded hover:bg-red-200 font-medium" data-acl-name="<%= acl.name %>">
                                        <i class="fas fa-trash mr-1"></i> Delete
                                    </button>
                                </div>

                                <div class="mt-3 p-3 bg-gray-50 rounded border border-gray-100">
                                    <p class="text-xs font-medium text-gray-600 mb-2">Entries:</p>
                                    <div class="space-y-1">
                                        <% acl.entries.forEach(entry => { %>
                                            <div class="text-sm text-gray-700">
                                                <% if (entry.negated) { %>
                                                    <span class="font-mono bg-red-100 text-red-700 px-2 py-1 rounded text-xs">!<%= entry.address %></span>
                                                <% } else { %>
                                                    <span class="font-mono bg-green-100 text-green-700 px-2 py-1 rounded text-xs"><%= entry.address %></span>
                                                <% } %>
                                                <span class="text-gray-500 ml-2"><%= entry.description %></span>
                                            </div>
                                        <% }); %>
                                    </div>
                                </div>
                            </div>
                        <% }); %>
                    </div>
                <% } %>
            </div>
        </div>
    </div>

    <!-- Master/Slave Zones Section -->
    <div class="mt-8 border-t pt-8">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">
            <i class="fas fa-sync text-indigo-600 mr-2"></i>
            Master & Slave Zones
        </h2>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Master Zones -->
            <div class="content-card">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                    <i class="fas fa-crown text-yellow-600 mr-2"></i>
                    Master Zones
                </h3>
                <div id="masterZonesList" class="space-y-2">
                    <div class="text-center text-gray-500 py-4">Loading...</div>
                </div>
            </div>

            <!-- Slave Zones -->
            <div class="content-card">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                    <i class="fas fa-copy text-blue-600 mr-2"></i>
                    Slave Zones
                </h3>
                <div id="slaveZonesList" class="space-y-2">
                    <div class="text-center text-gray-500 py-4">Loading...</div>
                </div>
            </div>
        </div>

        <!-- Convert Zone Form -->
        <div class="mt-6">
            <div class="content-card">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">
                    <i class="fas fa-exchange-alt text-indigo-600 mr-2"></i>
                    Convert Zone Type
                </h3>

                <form id="convertZoneForm" class="space-y-4">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Zone Name</label>
                            <input type="text" name="zoneName" id="convertZoneName"
                                class="form-input w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                placeholder="e.g., example.com" required>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Conversion Type</label>
                            <select id="conversionType" name="type" class="form-select w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" required>
                                <option value="">Select type...</option>
                                <option value="to-slave">Convert to Slave</option>
                                <option value="to-master">Convert to Master</option>
                            </select>
                        </div>

                        <div id="masterIpDiv" style="display:none;">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Master Server IP</label>
                            <input type="text" name="masterIp" id="masterIp"
                                class="form-input w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                placeholder="192.168.1.10">
                        </div>

                        <div id="zoneFileDiv" style="display:none;">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Zone File Path</label>
                            <input type="text" name="zoneFile" id="zoneFile"
                                class="form-input w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                placeholder="/etc/bind/zones/example.com.db">
                        </div>
                    </div>

                    <button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 font-medium">
                        Convert Zone
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Load master and slave zones on page load
async function loadZones() {
    try {
        // Load master zones
        const masterRes = await fetch('/acl/api/master-zones');
        const masterData = await masterRes.json();
        if (masterData.success) {
            const masterList = document.getElementById('masterZonesList');
            if (masterData.data.length === 0) {
                masterList.innerHTML = '<div class="text-center text-gray-500 py-4">No master zones</div>';
            } else {
                masterList.innerHTML = masterData.data.map(zone => `
                    <div class="p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <div class="font-semibold text-gray-800">${zone.name}</div>
                        <div class="text-xs text-gray-600 mt-1">${zone.file}</div>
                    </div>
                `).join('');
            }
        }

        // Load slave zones
        const slaveRes = await fetch('/acl/api/slave-zones');
        const slaveData = await slaveRes.json();
        if (slaveData.success) {
            const slaveList = document.getElementById('slaveZonesList');
            if (slaveData.data.length === 0) {
                slaveList.innerHTML = '<div class="text-center text-gray-500 py-4">No slave zones</div>';
            } else {
                slaveList.innerHTML = slaveData.data.map(zone => `
                    <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg">
                        <div class="font-semibold text-gray-800">${zone.name}</div>
                        <div class="text-xs text-gray-600 mt-1">
                            Masters: <span class="font-mono">${zone.masters.join(', ')}</span>
                        </div>
                    </div>
                `).join('');
            }
        }
    } catch (error) {
        console.error('Error loading zones:', error);
    }
}

// Handle conversion type change
document.getElementById('conversionType').addEventListener('change', function() {
    const masterIpDiv = document.getElementById('masterIpDiv');
    const zoneFileDiv = document.getElementById('zoneFileDiv');
    
    if (this.value === 'to-slave') {
        masterIpDiv.style.display = 'block';
        zoneFileDiv.style.display = 'none';
    } else if (this.value === 'to-master') {
        masterIpDiv.style.display = 'none';
        zoneFileDiv.style.display = 'block';
    } else {
        masterIpDiv.style.display = 'none';
        zoneFileDiv.style.display = 'none';
    }
});

// Handle zone conversion form submission
document.getElementById('convertZoneForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const zoneName = document.getElementById('convertZoneName').value.trim();
    const type = document.getElementById('conversionType').value;
    const masterIp = document.getElementById('masterIp').value.trim();
    const zoneFile = document.getElementById('zoneFile').value.trim();

    if (!zoneName || !type) {
        toastManager.error('Please fill all required fields');
        return;
    }

    if (type === 'to-slave' && !masterIp) {
        toastManager.error('Master server IP is required for slave conversion');
        return;
    }

    if (type === 'to-master' && !zoneFile) {
        toastManager.error('Zone file path is required for master conversion');
        return;
    }

    try {
        const endpoint = type === 'to-slave' ? '/acl/api/convert-to-slave' : '/acl/api/convert-to-master';
        const payload = type === 'to-slave' 
            ? { zoneName, masterIp }
            : { zoneName, file: zoneFile };

        const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        });

        const data = await response.json();

        if (data.success) {
            toastManager.success(data.message);
            document.getElementById('convertZoneForm').reset();
            loadZones();
        } else {
            toastManager.error(data.error || 'Failed to convert zone');
        }
    } catch (error) {
        console.error('Error:', error);
        toastManager.error('Error converting zone: ' + error.message);
    }
});

// Load zones on page load
loadZones();
</script>

<%- include('../partials/footer-standalone') %>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const addEntryBtn = document.getElementById('addEntryBtn');
    const entriesContainer = document.getElementById('entriesContainer');
    const createForm = document.getElementById('createACLForm');

    // Add entry button
    addEntryBtn.addEventListener('click', function() {
        const entryRow = document.createElement('div');
        entryRow.className = 'entry-row flex gap-2';
        entryRow.innerHTML = `
            <input type="text" class="entry-address flex-1 px-2 py-1 border border-gray-300 rounded text-sm"
                placeholder="IP address, range, or keyword">
            <label class="flex items-center whitespace-nowrap">
                <input type="checkbox" class="entry-negated mr-1">
                <span class="text-xs">Negate</span>
            </label>
            <button type="button" class="btn-remove-entry px-2 py-1 bg-red-100 text-red-600 text-xs rounded hover:bg-red-200">
                Remove
            </button>
        `;

        entryRow.querySelector('.btn-remove-entry').addEventListener('click', function(e) {
            e.preventDefault();
            entryRow.remove();
            updateRemoveButtons();
        });

        entriesContainer.appendChild(entryRow);
        updateRemoveButtons();
        entryRow.querySelector('.entry-address').focus();
    });

    function updateRemoveButtons() {
        const rows = document.querySelectorAll('.entry-row');
        rows.forEach(row => {
            const btn = row.querySelector('.btn-remove-entry');
            btn.style.display = rows.length > 1 ? 'block' : 'none';
        });
    }

    updateRemoveButtons();

    // Create ACL form submission
    createForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        const name = document.getElementById('aclName').value.trim();
        const description = document.getElementById('aclDescription').value.trim();
        
        const entries = [];
        document.querySelectorAll('.entry-row').forEach(row => {
            const address = row.querySelector('.entry-address').value.trim();
            const negated = row.querySelector('.entry-negated').checked;
            if (address) {
                entries.push({ address, negated });
            }
        });

        if (!name) {
            toastManager.error('Please enter an ACL name');
            return;
        }

        if (entries.length === 0) {
            toastManager.error('Please add at least one entry');
            return;
        }

        try {
            const response = await fetch('/acl/api/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name, entries, description })
            });

            const data = await response.json();

            if (data.success) {
                toastManager.success(data.message);
                createForm.reset();
                updateRemoveButtons();
                setTimeout(() => window.location.reload(), 1500);
            } else {
                toastManager.error(data.error || 'Failed to create ACL');
            }
        } catch (error) {
            console.error('Error:', error);
            toastManager.error('Error creating ACL: ' + error.message);
        }
    });

    // Delete ACL buttons
    document.querySelectorAll('.btn-delete-acl').forEach(btn => {
        btn.addEventListener('click', async function() {
            const aclName = this.dataset.aclName;

            if (!confirm(`Are you sure you want to delete ACL "${aclName}"?`)) {
                return;
            }

            try {
                const response = await fetch('/acl/api/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name: aclName })
                });

                const data = await response.json();

                if (data.success) {
                    toastManager.success(data.message);
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    toastManager.error(data.error || 'Failed to delete ACL');
                }
            } catch (error) {
                console.error('Error:', error);
                toastManager.error('Error deleting ACL: ' + error.message);
            }
        });
    });
});
</script>

<%- include('../partials/footer-standalone') %>
